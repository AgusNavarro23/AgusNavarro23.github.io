<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard CompraVenta</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0,0,0,0.15);
        }
        .stat-card {
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .positive {
            color: #28a745;
        }
        .negative {
            color: #dc3545;
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 2rem;
        }
        .chart-container-small {
            position: relative;
            height: 350px;
            margin-bottom: 2rem;
        }
        .file-upload-area {
            border: 2px dashed #667eea;
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: white;
        }
        .file-upload-area:hover {
            background-color: #f0f0ff;
            border-color: #764ba2;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 0.7rem 2rem;
            border-radius: 25px;
        }
        .section-title {
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #333;
        }
        .filter-section {
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
        }
        .form-select, .form-control {
            border-radius: 10px;
        }
        .badge-top {
            background-color: #28a745;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            display: inline-block;
            margin-bottom: 1rem;
        }
        .badge-bottom {
            background-color: #dc3545;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            display: inline-block;
            margin-bottom: 1rem;
        }
        #amountTabContent {
            /* Retira el filtro inicial, lo aplicaremos solo si est치 protegido */
        }
        #passwordOverlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(248, 249, 250, 0.9);
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="container">
            <h1 class="text-center mb-0">Estad칤sticas CompraVenta</h1>
        </div>
    </div>

    <div class="container">
        <div class="row mb-4">
            <div class="col-12">
                <div class="file-upload-area" onclick="document.getElementById('csvFile').click()">
                    <input type="file" id="csvFile" accept=".csv" style="display: none;">
                    <h4>Cargar archivo CSV</h4>
                    <p class="text-muted mb-0">Haz clic aqu칤 o arrastra tu archivo CSV</p>
                </div>
            </div>
        </div>

        <div id="dashboardContent" style="display: none;">
            <ul class="nav nav-tabs" id="dataTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="quantity-tab" data-bs-toggle="tab" data-bs-target="#quantity-tab-pane" type="button" role="tab" aria-controls="quantity-tab-pane" aria-selected="true" onclick="switchData('quantity')">Cantidades</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="amount-tab" data-bs-toggle="tab" data-bs-target="#amount-tab-pane" type="button" role="tab" aria-controls="amount-tab-pane" aria-selected="false" onclick="handleAmountTabClick()">Montos</button>
                </li>
            </ul>

            <div class="tab-content pt-3" id="dataTabContent">
                <div class="tab-pane fade show active" id="quantity-tab-pane" role="tabpanel" aria-labelledby="quantity-tab" tabindex="0">
                    <div id="quantityTabContent">
                        <div class="filter-section">
                            <h5 class="mb-3">Filtros</h5>
                            <div class="row g-3">
                                <div class="col-md-2">
                                    <label class="form-label">Mes desde</label>
                                    <select class="form-select" id="filterMesDesdeQ">
                                        <option value="0">Inicio</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Mes hasta</label>
                                    <select class="form-select" id="filterMesHastaQ">
                                        <option value="11">Fin</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">&nbsp;</label>
                                    <button class="btn btn-primary w-100" onclick="applyFilters('quantity')">Aplicar Filtros</button>
                                </div>
                            </div>
                        </div>
                        <div id="quantityDashboard">
                            </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="amount-tab-pane" role="tabpanel" aria-labelledby="amount-tab" tabindex="0" style="position: relative; min-height: 80vh;">
                    <div id="passwordOverlay" style="display: none;">
                        <div class="card p-4 shadow-lg text-center">
                            <h4>Acceso Restringido 游</h4>
                            <p>Ingresa la contrase침a para ver los Montos.</p>
                            <input type="password" id="passwordInput" class="form-control mb-3" placeholder="Contrase침a">
                            <button class="btn btn-primary" onclick="checkPassword()">Acceder</button>
                            <p class="text-muted mt-2 mb-0" style="font-size: 0.8rem;">Pista: Contrase침a es 'admin'</p>
                        </div>
                    </div>
                    <div id="amountTabContent">
                        <div class="filter-section">
                            <h5 class="mb-3">Filtros</h5>
                            <div class="row g-3">
                                <div class="col-md-2">
                                    <label class="form-label">Mes desde</label>
                                    <select class="form-select" id="filterMesDesdeM">
                                        <option value="0">Inicio</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Mes hasta</label>
                                    <select class="form-select" id="filterMesHastaM">
                                        <option value="11">Fin</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">&nbsp;</label>
                                    <button class="btn btn-primary w-100" onclick="applyFilters('amount')">Aplicar Filtros</button>
                                </div>
                            </div>
                        </div>
                        <div id="amountDashboard">
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Objeto global para almacenar todos los datos parseados
        let allData = {
            labels: [],
            quantity2023: [],
            quantity2024: [],
            amount2023: [],
            amount2024: []
        };
        let chartInstances = {};
        let currentDataType = 'quantity';
        let isAmountUnlocked = false; // Nuevo estado para la protecci칩n
        const PASSWORD = 'admin';
        
        // Formateador de moneda (ajusta a tu moneda local si es necesario)
        const currencyFormatter = new Intl.NumberFormat('es-AR', {
            style: 'currency',
            currency: 'ARS',
            minimumFractionDigits: 2,
        });

        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    parseAndDisplay(event.target.result);
                };
                reader.readAsText(file);
            }
        });
        
        // --- Password Logic ---
        function checkPassword() {
            const input = document.getElementById('passwordInput').value;
            if (input === PASSWORD) {
                isAmountUnlocked = true;
                document.getElementById('passwordOverlay').style.display = 'none';
                switchData('amount');
            } else {
                alert('Contrase침a incorrecta.');
                document.getElementById('passwordInput').value = ''; // Clear input
            }
        }

        function handleAmountTabClick() {
            if (!isAmountUnlocked) {
                document.getElementById('passwordOverlay').style.display = 'flex';
            } else {
                switchData('amount');
            }
        }
        
        // --- Data Parsing ---
        function cleanAndParseNumber(value, isAmount = false) {
            let cleaned = value.replace(/"/g, '').replace(/\$/g, '').trim();
            if (isAmount) {
                 // Si el formato es ###.###.###,##, quitamos los puntos de miles y convertimos la coma en punto para JS
                cleaned = cleaned.replace(/\./g, '').replace(/,/g, '.');
            }
            return parseFloat(cleaned) || 0;
        }

        function parseAndDisplay(csvData) {
            const lines = csvData.split('\n').filter(line => line.trim());
            
            allData = {
                labels: [],
                quantity2023: [],
                quantity2024: [],
                amount2023: [],
                amount2024: []
            };

            for (let i = 3; i < lines.length; i++) {
                const line = lines[i];
                // Regex para manejar campos entre comillas (como los montos)
                const parts = line.match(/(".*?"|[^,]+)(?=,|$)/g) || [];
                
                // Limpiar partes
                const cleanedParts = parts.map(p => p.trim());
                
                // El CSV tiene Periodo,Cantidad,Monto(2023),Periodo,Cantidad,Monto(2024)
                // Usaremos los 칤ndices 1, 2, 4, 5
                if (cleanedParts.length >= 6) {
                    // La etiqueta del mes est치 en el 칤ndice 0 o 3. Usamos el 0.
                    const month = cleanedParts[0].split('-')[0].trim();
                    allData.labels.push(month.charAt(0).toUpperCase() + month.slice(1));
                    
                    // Columnas de datos:
                    // 칈ndice 1: Cantidad 2023
                    // 칈ndice 2: Monto 2023
                    // 칈ndice 4: Cantidad 2024
                    // 칈ndice 5: Monto 2024
                    allData.quantity2023.push(cleanAndParseNumber(cleanedParts[1]));
                    allData.amount2023.push(cleanAndParseNumber(cleanedParts[2], true)); // true para Monto
                    allData.quantity2024.push(cleanAndParseNumber(cleanedParts[4]));
                    allData.amount2024.push(cleanAndParseNumber(cleanedParts[5], true)); // true para Monto
                }
            }

            // Populate filter dropdowns for both tabs
            populateFilters(allData.labels);
            
            // Generate initial dashboard for Quantities
            generateDashboardHTML('quantity');
            // 游냍 CORRECCI칍N: Llamamos sin argumentos de datos. La funci칩n displaySummaryCards usa los datos globales por defecto.
            displaySummaryCards('quantity'); 
            createCharts('quantity');
            
            // Generate dashboard structure for Amounts (hidden initially)
            generateDashboardHTML('amount');
            
            // Hide/Show content
            document.getElementById('dashboardContent').style.display = 'block';
            
            // Ocultar el overlay de contrase침a por defecto, se muestra al hacer clic
            document.getElementById('passwordOverlay').style.display = 'flex';
        }

        // --- Filter Logic ---
        function populateFilters(labels) {
            const filterIds = [
                'filterMesDesdeQ', 'filterMesHastaQ', 
                'filterMesDesdeM', 'filterMesHastaM'
            ];

            filterIds.forEach(id => {
                const filterElement = document.getElementById(id);
                // Clear existing options except first
                filterElement.innerHTML = '<option value="0">Inicio</option>';
                
                labels.forEach((label, index) => {
                    filterElement.innerHTML += `<option value="${index}">${label}</option>`;
                });
                
                // Set last month as default for "hasta"
                filterElement.value = labels.length > 0;
            });
        }

        function applyFilters(dataType) {
            const suffix = dataType === 'quantity' ? 'Q' : 'M';
            const mesDesde = parseInt(document.getElementById(`filterMesDesde${suffix}`).value);
            const mesHasta = parseInt(document.getElementById(`filterMesHasta${suffix}`).value);
            
            // Validar
            if (mesDesde > mesHasta) {
                alert('El mes de inicio no puede ser posterior al mes de fin.');
                return;
            }
            
            // Aplicar filtros
            let labels = allData.labels.slice(mesDesde, mesHasta + 1);
            let data2023 = allData[`${dataType}2023`].slice(mesDesde, mesHasta + 1);
            let data2024 = allData[`${dataType}2024`].slice(mesDesde, mesHasta + 1);
            
            displaySummaryCards(dataType, data2023, data2024);
            createCharts(dataType, labels, data2023, data2024);
        }
        
        // --- Dashboard Management ---
        function switchData(dataType) {
            currentDataType = dataType;
            
            // Obtener los filtros aplicados (o defaults)
            const suffix = dataType === 'quantity' ? 'Q' : 'M';
            // Usar .value y asegurar que la data est치 sincronizada con el filtro actual
            const mesDesde = parseInt(document.getElementById(`filterMesDesde${suffix}`).value);
            const mesHasta = parseInt(document.getElementById(`filterMesHasta${suffix}`).value);
            
            // Aplicar filtros
            let labels = allData.labels.slice(mesDesde, mesHasta + 1);
            let data2023 = allData[`${dataType}2023`].slice(mesDesde, mesHasta + 1);
            let data2024 = allData[`${dataType}2024`].slice(mesDesde, mesHasta + 1);
            
            displaySummaryCards(dataType, data2023, data2024);
            createCharts(dataType, labels, data2023, data2024);
        }

        function generateDashboardHTML(dataType) {
            const containerId = dataType === 'quantity' ? 'quantityDashboard' : 'amountDashboard';
            const unitLabel = dataType === 'quantity' ? 'unidades' : 'monto total';
            const currencyPrefix = dataType === 'amount' ? 'en Monto' : '';
            const topBottomLabel = dataType === 'quantity' ? 'Cantidad' : 'Monto';
            
            // Esta funci칩n solo genera el esqueleto si ya est치 creado
            if(document.getElementById(containerId).innerHTML.trim() !== "") return;
            
            document.getElementById(containerId).innerHTML = `
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card stat-card">
                            <div class="stat-label">Periodo 2023-2024</div>
                            <div class="stat-value" id="total2023-${dataType}"></div>
                            <div class="text-muted">Total de ${unitLabel}</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card stat-card">
                            <div class="stat-label">Periodo 2024-2025</div>
                            <div class="stat-value" id="total2024-${dataType}"></div>
                            <div class="text-muted">Total de ${unitLabel}</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card stat-card">
                            <div class="stat-label">Variaci칩n</div>
                            <div class="stat-value" id="variation-${dataType}"></div>
                            <div class="text-muted">Diferencia entre periodos</div>
                        </div>
                    </div>
                </div>

                <h3 class="section-title">游늵 Comparaci칩n por Periodo ${currencyPrefix}</h3>
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card p-3">
                            <h5 class="text-center">Periodo 2023-2024</h5>
                            <div class="chart-container">
                                <canvas id="chart2023-${dataType}"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card p-3">
                            <h5 class="text-center">Periodo 2024-2025</h5>
                            <div class="chart-container">
                                <canvas id="chart2024-${dataType}"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <h3 class="section-title">游늳 Tendencia Combinada ${currencyPrefix}</h3>
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card p-3">
                            <div class="chart-container">
                                <canvas id="lineChart-${dataType}"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <h3 class="section-title">游끥 Meses con Mayor ${topBottomLabel}</h3>
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card p-3">
                            <span class="badge-top">TOP 3</span>
                            <h5 class="text-center">Mejores Meses - Periodo 2023-2024</h5>
                            <div class="chart-container-small">
                                <canvas id="pieTop2023-${dataType}"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card p-3">
                            <span class="badge-top">TOP 3</span>
                            <h5 class="text-center">Mejores Meses - Periodo 2024-2025</h5>
                            <div class="chart-container-small">
                                <canvas id="pieTop2024-${dataType}"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <h3 class="section-title">游늴 Meses con Menor ${topBottomLabel}</h3>
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card p-3">
                            <span class="badge-bottom">LOW 3</span>
                            <h5 class="text-center">Peores Meses - Periodo 2023-2024</h5>
                            <div class="chart-container-small">
                                <canvas id="pieBottom2023-${dataType}"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card p-3">
                            <span class="badge-bottom">LOW 3</span>
                            <h5 class="text-center">Peores Meses - Periodo 2024-2025</h5>
                            <div class="chart-container-small">
                                <canvas id="pieBottom2024-${dataType}"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 游릭 FUNCI칍N CORREGIDA
        function displaySummaryCards(dataType, data2023, data2024) {
            // Utilizamos los datos proporcionados por los filtros, o los datos globales si la llamada es inicial (data2023/data2024 es undefined)
            const finalData2023 = data2023 !== undefined ? data2023 : allData[`${dataType}2023`];
            const finalData2024 = data2024 !== undefined ? data2024 : allData[`${dataType}2024`];

            const total2023 = finalData2023.reduce((a, b) => a + b, 0);
            const total2024 = finalData2024.reduce((a, b) => a + b, 0);
            const variation = total2024 - total2023;
            const variationPercent = total2023 > 0 ? ((variation / total2023) * 100) : 0;
            
            const formatValue = dataType === 'amount' 
                ? (val) => currencyFormatter.format(val) 
                : (val) => Math.round(val).toLocaleString('es-AR'); 

            document.getElementById(`total2023-${dataType}`).textContent = formatValue(total2023);
            document.getElementById(`total2024-${dataType}`).textContent = formatValue(total2024);
            
            const variationElement = document.getElementById(`variation-${dataType}`);
            const sign = variation >= 0 ? '+' : '';
            
            let variationText = `${sign}${formatValue(variation)} (${sign}${variationPercent.toFixed(2)}%)`;
            
            variationElement.textContent = variationText;
            variationElement.className = `stat-value ${variation >= 0 ? 'positive' : 'negative'}`;
        }

        // --- Charts Generation ---
        function createCharts(dataType, labels, data2023, data2024) {
            // Destruir instancias anteriores del tipo de dato actual
            Object.values(chartInstances[dataType] || {}).forEach(chart => chart && chart.destroy());
            chartInstances[dataType] = {};
            
            // Si labels, data2023 o data2024 no se pasaron, usamos los datos globales
            const currentLabels = labels !== undefined ? labels : allData.labels;
            const currentData2023 = data2023 !== undefined ? data2023 : allData[`${dataType}2023`];
            const currentData2024 = data2024 !== undefined ? data2024 : allData[`${dataType}2024`];
            
            const tooltipLabel = dataType === 'quantity' ? 'Cantidad' : 'Monto';
            const unitLabel = dataType === 'quantity' ? '' : ' (ARS)';
            
            const currencyScale = dataType === 'amount' ? {
                callbacks: {
                    label: function(context) {
                        return currencyFormatter.format(context.raw);
                    }
                }
            } : {};
            
            const barOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                         callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (dataType === 'amount') {
                                    label += currencyFormatter.format(context.parsed.y);
                                } else {
                                    label += context.parsed.y.toLocaleString('es-AR');
                                }
                                return label;
                            }
                        }
                    },
                    legend: { display: true }
                },
                scales: { y: currencyScale }
            };

            // 1. Column Chart 2023
            chartInstances[dataType]['chart2023'] = new Chart(document.getElementById(`chart2023-${dataType}`), {
                type: 'bar',
                data: {
                    labels: currentLabels,
                    datasets: [{
                        label: `${tooltipLabel} 2023-2024${unitLabel}`,
                        data: currentData2023,
                        backgroundColor: 'rgba(102, 126, 234, 0.7)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: barOptions
            });

            // 2. Column Chart 2024
            chartInstances[dataType]['chart2024'] = new Chart(document.getElementById(`chart2024-${dataType}`), {
                type: 'bar',
                data: {
                    labels: currentLabels,
                    datasets: [{
                        label: `${tooltipLabel} 2024-2025${unitLabel}`,
                        data: currentData2024,
                        backgroundColor: 'rgba(118, 75, 162, 0.7)',
                        borderColor: 'rgba(118, 75, 162, 1)',
                        borderWidth: 2
                    }]
                },
                options: barOptions
            });

            // 3. Line Chart Combined
            chartInstances[dataType]['lineChart'] = new Chart(document.getElementById(`lineChart-${dataType}`), {
                type: 'line',
                data: {
                    labels: currentLabels,
                    datasets: [
                        {
                            label: `Periodo 2023-2024${unitLabel}`,
                            data: currentData2023,
                            borderColor: 'rgba(102, 126, 234, 1)',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: `Periodo 2024-2025${unitLabel}`,
                            data: currentData2024,
                            borderColor: 'rgba(118, 75, 162, 1)',
                            backgroundColor: 'rgba(118, 75, 162, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: barOptions
            });

            // 4. Pie Charts - Top and Bottom
            chartInstances[dataType]['pieTop2023'] = createTopPieChart(`pieTop2023-${dataType}`, currentLabels, currentData2023, dataType);
            chartInstances[dataType]['pieTop2024'] = createTopPieChart(`pieTop2024-${dataType}`, currentLabels, currentData2024, dataType);
            chartInstances[dataType]['pieBottom2023'] = createBottomPieChart(`pieBottom2023-${dataType}`, currentLabels, currentData2023, dataType);
            chartInstances[dataType]['pieBottom2024'] = createBottomPieChart(`pieBottom2024-${dataType}`, currentLabels, currentData2024, dataType);
        }

        // 游릭 FUNCI칍N CORREGIDA
        function createTopPieChart(canvasId, labels, data, dataType) {
            // 1. Crear el array indexado y asegurar que solo hay meses v치lidos
            const indexed = data
                .map((val, idx) => ({ label: labels[idx], value: val }))
                .filter(item => item.label);
                
            // 2. Ordenar de mayor a menor
            indexed.sort((a, b) => b.value - a.value);
            
            // 3. Tomar los 3 primeros y luego filtrar valores 0 o negativos.
            const top3 = indexed.slice(0, 3).filter(item => item.value > 0); 

            // Si top3 est치 vac칤o, no se crea el gr치fico (se devuelve null)
            if (top3.length === 0) {
                 return null; 
            }

            const colors = [
                'rgba(40, 167, 69, 0.8)',
                'rgba(102, 126, 234, 0.8)',
                'rgba(52, 211, 153, 0.8)'
            ];
            
            const formatValue = dataType === 'amount' ? currencyFormatter.format : (val) => val.toLocaleString('es-AR');

            return new Chart(document.getElementById(canvasId), {
                type: 'pie',
                data: {
                    labels: top3.map(item => item.label),
                    datasets: [{
                        data: top3.map(item => item.value),
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += formatValue(context.parsed);
                                    return label;
                                }
                            }
                        },
                        legend: { position: 'bottom' }
                    }
                }
            });
        }
        
        // 游릭 FUNCI칍N CORREGIDA
        function createBottomPieChart(canvasId, labels, data, dataType) {
            const indexed = data
                .map((val, idx) => ({ label: labels[idx], value: val }))
                .filter(item => item.label);
                
            // Ordenar por valor ascendente
            indexed.sort((a, b) => a.value - b.value);
            
            // Tomamos los 3 primeros elementos y luego filtramos para solo mostrar aquellos con valor > 0.
            const bottom3 = indexed.slice(0, 3).filter(item => item.value > 0); 

            // Si bottom3 est치 vac칤o, no se crea el gr치fico (se devuelve null)
            if (bottom3.length === 0) {
                 return null; 
            }

            const colors = [
                'rgba(220, 53, 69, 0.8)',
                'rgba(255, 152, 0, 0.8)',
                'rgba(255, 193, 7, 0.8)'
            ];

            const formatValue = dataType === 'amount' ? currencyFormatter.format : (val) => val.toLocaleString('es-AR');

            return new Chart(document.getElementById(canvasId), {
                type: 'pie',
                data: {
                    labels: bottom3.map(item => item.label),
                    datasets: [{
                        data: bottom3.map(item => item.value),
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += formatValue(context.parsed);
                                    return label;
                                }
                            }
                        },
                        legend: { position: 'bottom' }
                    }
                }
            });
        }
    </script>
</body>
</html>
