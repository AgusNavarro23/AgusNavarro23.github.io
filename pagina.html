<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificador de Medicamentos</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f7fa;
            color: #333;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }

        .upload-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .file-inputs {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .file-input {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        input[type="file"],
        input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            display: block;
            margin: 0 auto;
        }

        button:hover {
            background-color: #2980b9;
        }

        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        .results-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e1e1e1;
        }

        th {
            background-color: #f2f6fc;
            font-weight: 600;
            color: #2c3e50;
        }

        tr:hover {
            background-color: #f9fafb;
        }

        .status-bien {
            color: #27ae60;
            font-weight: 600;
        }

        .status-incongruencias {
            color: #e74c3c;
            font-weight: 600;
        }

        .cantidad-coincide {
            background-color: #d4edda;
            color: #155724;
            font-weight: 600;
        }

        .cantidad-no-coincide {
            background-color: #f8d7da;
            color: #721c24;
            font-weight: 600;
        }

        .cantidad-no-encontrada {
            background-color: #fff3cd;
            color: #856404;
        }

        .summary {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #3498db;
        }

        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            color: #e74c3c;
            background-color: #fdf2f2;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <h1>Verificador de Medicamentos</h1>

    <div class="upload-section">
        <div class="file-inputs">
            <div class="file-input">
                <label for="pdf-file">Archivo PDF (Prescripciones):</label>
                <input type="file" id="pdf-file" accept=".pdf">
            </div>
            <div class="file-input">
                <label for="excel-file">Archivo Excel (Facturación):</label>
                <input type="file" id="excel-file" accept=".xls,.xlsx">
            </div>
        </div>

        <div class="file-input" style="margin-bottom: 20px;">
            <label for="fila-inicial">Fila inicial del Excel (número):</label>
            <input type="number" id="fila-inicial" min="1" value="2">
        </div>

        <div class="file-inputs" style="margin-bottom: 20px;">
            <div class="file-input">
                <label for="pagina-inicial">Página inicial del PDF:</label>
                <input type="number" id="pagina-inicial" min="1" value="1">
            </div>
            <div class="file-input">
                <label for="pagina-final">Página final del PDF (dejar vacío para todas):</label>
                <input type="number" id="pagina-final" min="1" placeholder="Todas">
            </div>
        </div>

        <button id="process-btn" disabled>Procesar Archivos</button>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Procesando archivos, por favor espere...</p>
        </div>

        <div class="error" id="error-message"></div>
    </div>

    <div class="results-section" id="results-section" style="display: none;">
        <h2>Resultados de la Verificación</h2>
        <div id="table-container"></div>
        <div class="summary" id="summary"></div>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.min.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.worker.min.js';

const pdfFileInput = document.getElementById('pdf-file');
const excelFileInput = document.getElementById('excel-file');
const filaInicialInput = document.getElementById('fila-inicial');
const paginaInicialInput = document.getElementById('pagina-inicial');
const paginaFinalInput = document.getElementById('pagina-final');
const processBtn = document.getElementById('process-btn');
const loading = document.getElementById('loading');
const errorMessage = document.getElementById('error-message');
const resultsSection = document.getElementById('results-section');
const tableContainer = document.getElementById('table-container');
const summary = document.getElementById('summary');

let pdfData = [];
let excelData = [];

pdfFileInput.addEventListener('change', checkFiles);
excelFileInput.addEventListener('change', checkFiles);

function checkFiles() {
  processBtn.disabled = !(pdfFileInput.files.length && excelFileInput.files.length);
}

processBtn.addEventListener('click', async () => {
  loading.style.display = 'block';
  errorMessage.style.display = 'none';
  resultsSection.style.display = 'none';
  try {
    pdfData = await extractMedicinesFromPDF(pdfFileInput.files[0]);
    excelData = await readExcel(excelFileInput.files[0]);
    
    // Matchear datos del PDF con Excel y llenar cantidadPrescripta
    matchPDFWithExcel();
    
    displayPDFTable();
    compareAndDisplayResults();
    loading.style.display = 'none';
    resultsSection.style.display = 'block';
  } catch (err) {
    loading.style.display = 'none';
    errorMessage.textContent = 'Error: ' + err.message;
    errorMessage.style.display = 'block';
  }
});

/* === LECTURA PDF CORREGIDA === */
async function extractMedicinesFromPDF(file) {
  const buf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
  
  // Obtener rango de páginas
  const paginaInicial = parseInt(paginaInicialInput.value) || 1;
  const paginaFinal = parseInt(paginaFinalInput.value) || pdf.numPages;
  
  // Validar rango
  const startPage = Math.max(1, Math.min(paginaInicial, pdf.numPages));
  const endPage = Math.max(startPage, Math.min(paginaFinal, pdf.numPages));
  
  const records = [];
  
  for (let pageNum = startPage; pageNum <= endPage; pageNum++) {
    const page = await pdf.getPage(pageNum);
    const textContent = await page.getTextContent();
    
    // Obtener las posiciones de los textos para entender la estructura de tabla
    const items = textContent.items;
    
    // Buscar patrones de tabla: código de medicamento seguido de nombre y luego cantidad
    let currentFecha = '';
    
    for (let i = 0; i < items.length; i++) {
      const item = items[i];
      const text = item.str.trim();
      
      // Detectar fecha
      if (/^\d{2}\/\d{2}\/\d{4}$/.test(text)) {
        currentFecha = text;
        continue;
      }
      
      // Detectar códigos de medicamento (Mxxxx o números)
      if (/^(M\d+|10562|10957)$/.test(text)) {
        const codigo = text;
        let medicamento = '';
        let cantidad = null;
        
        // Buscar el nombre del medicamento (siguientes elementos en la misma línea o cercanos)
        let j = i + 1;
        while (j < items.length && j < i + 10) { // Limitar la búsqueda
          const nextText = items[j].str.trim();
          
          // Si encontramos un número con decimales, probablemente sea la cantidad
          if (/^\d+\.\d+$/.test(nextText)) {
            cantidad = parseFloat(nextText);
            break;
          }
          
          // Si encontramos otro código o fecha, terminamos
          if (/^(M\d+|10562|10957|\d{2}\/\d{2}\/\d{4})$/.test(nextText)) {
            break;
          }
          
          // Agregar al nombre del medicamento (excluir palabras vacías o de formato)
          if (nextText && !/^(Directo|Ampollas|Comprimidos|Unidades|Endovenoso|Subcutánea|Sonda|Nasogatrica|Nasoyeyunal|Oral|1 c\/|Unica Dosis)$/.test(nextText)) {
            medicamento += nextText + ' ';
          }
          
          j++;
        }
        
        // Buscar específicamente la cantidad si no la encontramos antes
        if (cantidad === null) {
          for (let k = i; k < Math.min(i + 15, items.length); k++) {
            const potentialQty = items[k].str.trim();
            if (/^\d+\.\d+$/.test(potentialQty)) {
              cantidad = parseFloat(potentialQty);
              break;
            }
          }
        }
        
        if (currentFecha && cantidad !== null && medicamento.trim()) {
          records.push({
            fecha: currentFecha,
            codigo: codigo,
            medicamento: medicamento.trim(),
            cantidad: cantidad,
            pagina: pageNum
          });
        }
      }
    }
  }

  if (records.length === 0) throw new Error(`No se detectaron medicamentos en el PDF (páginas ${startPage}-${endPage}).`);
  return records;
}

/* === LECTURA EXCEL === */
function readExcel(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const startRow = parseInt(filaInicialInput.value) || 1;
        const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false });
        const data = [];
        for (let i = startRow - 1; i < rows.length; i++) {
          const row = rows[i];
          if (!row || !row[0]) continue;
          
          let fecha = row[0];
          data.push({
            rowIndex: i,
            fecha: fecha,
            codigo: String(row[1] || '').trim().toUpperCase(),
            detalle: String(row[2] || '').trim(),
            cantidad: parseFloat(row[3]) || 0,
          });
        }
        resolve(data);
      } catch (err) {
        reject(err);
      }
    };
    reader.onerror = () => reject(new Error('Error al leer el Excel.'));
    reader.readAsArrayBuffer(file);
  });
}

// Función auxiliar para normalizar fechas
function normalizarFecha(fecha) {
  if (!fecha) return '';
  
  // Si ya está en formato DD/MM/YYYY, retornar
  if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(fecha)) {
    const partes = fecha.split('/');
    const dia = partes[0].padStart(2, '0');
    const mes = partes[1].padStart(2, '0');
    const anio = partes[2];
    return `${dia}/${mes}/${anio}`;
  }
  
  // Si está en formato M/D/YY (9/16/25), convertir a DD/MM/YYYY
  const match = fecha.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
  if (match) {
    let [, mes, dia, anio] = match;
    
    // Convertir año de 2 dígitos a 4 dígitos
    if (anio.length === 2) {
      anio = '20' + anio;
    }
    
    // Asegurar que día y mes tengan 2 dígitos
    dia = dia.padStart(2, '0');
    mes = mes.padStart(2, '0');
    
    return `${dia}/${mes}/${anio}`;
  }
  
  return String(fecha);
}

/* === MATCHEAR PDF CON EXCEL === */
function matchPDFWithExcel() {
  // Inicializar cantidadPrescripta en null para todos los registros de Excel
  excelData.forEach(row => {
    row.cantidadPrescripta = null;
  });

  // Para cada registro del Excel, buscar en PDF
  excelData.forEach(excelRow => {
    const match = pdfData.find(pdfRow => {
      // Normalizar códigos: remover prefijos M o D
      const codeA = pdfRow.codigo.replace(/^[MD]/, '');
      const codeB = excelRow.codigo.replace(/^[MD]/, '');
      
      // Normalizar fechas para comparación
      const fechaA = normalizarFecha(pdfRow.fecha);
      const fechaB = normalizarFecha(excelRow.fecha);
      
      return fechaA === fechaB && codeA === codeB;
    });
    
    if (match) {
      excelRow.cantidadPrescripta = match.cantidad;
    }
  });
}

/* === MOSTRAR TABLA PDF === */
function displayPDFTable() {
  const paginaInicial = parseInt(paginaInicialInput.value) || 1;
  const paginaFinal = parseInt(paginaFinalInput.value) || 'última';
  
  let html = `
    <h3>Tabla extraída del PDF</h3>
    <p><strong>Rango analizado:</strong> Páginas ${paginaInicial} - ${paginaFinal}</p>
    <p><strong>Total detectado:</strong> ${pdfData.length} registros</p>
    <table>
      <thead>
        <tr>
          <th>Página</th>
          <th>Fecha</th>
          <th>Código</th>
          <th>Medicamento</th>
          <th>Cantidad Prescripta</th>
        </tr>
      </thead>
      <tbody>
  `;

  pdfData.forEach(row => {
    html += `
      <tr>
        <td>${row.pagina}</td>
        <td>${row.fecha}</td>
        <td>${row.codigo}</td>
        <td>${row.medicamento}</td>
        <td>${row.cantidad}</td>
      </tr>
    `;
  });

  html += '</tbody></table><hr>';
  tableContainer.innerHTML = html;
}

/* === COMPARAR Y MOSTRAR === */
function compareAndDisplayResults() {
  let html = `
    <h3>Resultados de la comparación PDF vs Excel</h3>
    <table>
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Código</th>
          <th>Detalle</th>
          <th>Cantidad Facturada</th>
          <th>Cantidad Prescripta</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody>
  `;

  let coinciden = 0, noCoinciden = 0, noEncontrados = 0;
  
  excelData.forEach(row => {
    const enPDF = row.cantidadPrescripta !== null && row.cantidadPrescripta !== undefined;
    
    let estado = '';
    let claseEstado = '';
    let claseCantidadPrescripta = '';
    
    if (enPDF) {
      // Comparar cantidades con tolerancia para decimales
      const cantidadesCoinciden = Math.abs(row.cantidad - row.cantidadPrescripta) < 0.01;
      
      if (cantidadesCoinciden) {
        coinciden++;
        estado = 'Coincide';
        claseEstado = 'status-bien';
        claseCantidadPrescripta = 'cantidad-coincide';
      } else {
        noCoinciden++;
        estado = 'No coincide';
        claseEstado = 'status-incongruencias';
        claseCantidadPrescripta = 'cantidad-no-coincide';
      }
    } else {
      noEncontrados++;
      estado = 'No encontrado en PDF';
      claseEstado = 'status-incongruencias';
      claseCantidadPrescripta = 'cantidad-no-encontrada';
    }

    html += `
      <tr>
        <td>${row.fecha}</td>
        <td>${row.codigo}</td>
        <td>${row.detalle}</td>
        <td>${row.cantidad}</td>
        <td class="${claseCantidadPrescripta}">${enPDF ? row.cantidadPrescripta : 'N/A'}</td>
        <td class="${claseEstado}">${estado}</td>
      </tr>
    `;
  });

  html += '</tbody></table>';
  tableContainer.innerHTML += html;
  
  summary.innerHTML = `
    <h3>Resumen</h3>
    <p><strong>Total de registros Excel:</strong> ${excelData.length}</p>
    <p><strong>Cantidades que coinciden:</strong> <span class="status-bien">${coinciden}</span></p>
    <p><strong>Cantidades que NO coinciden:</strong> <span class="status-incongruencias">${noCoinciden}</span></p>
    <p><strong>No encontrados en PDF:</strong> <span class="status-incongruencias">${noEncontrados}</span></p>
  `;
}
</script>
</body>
</html>